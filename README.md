# MLR-Notification-Service

[![Build Status](https://travis-ci.org/USGS-CIDA/MLR-Notification-Service.svg?branch=master)](https://travis-ci.org/USGS-CIDA/MLR-Notification-Service) [![Coverage Status](https://coveralls.io/repos/github/USGS-CIDA/MLR-Notification-Service/badge.svg?branch=master)](https://coveralls.io/github/USGS-CIDA/MLR-Notification-Service?branch=master)

## Service Description

This service is part of the MLR microservices and is responsible for creating and sending emails to users when their workflows are finished processing. The service does not generate the content of the email itself, but rather expects that to be sent as part of the request to send the email. The service uses a JSON input format to describe the content of the email including the recipients, any CC or BCC recipients, the content type (HTML or Plaintext), the subject, the content, and any attachments. Having the service mostly devoid of any business logic, outside the scope of converting that JSON document to an email and sending it, allows it to be extremely flexible and potentially useful outside the scope of just MLR in the future.

The service can be heavily configured including the mail server to use and default values for several parameters such as the email sender ("from" field).

The service has only a single business logic API method, which is a POST method at `/email` which sends an email using the provided JSON request body. Specifics about this API method can be read from the service Swagger API documentation.

This service is always the last step of MLR Gateway workflows and is only contacted once per workflow run. It has been discussed to further utilize this service within MLR to send notification emails to Operations when certain parts of workflows fail, but this is not currently implemented.

## Environment Variables

* MLR_NOTIFICATION_EMAIL_FROM - The email address to send emails from this service as. I.E: The `from` address for emails generated by this service.

* MLR_NOTIFICATION_EMAIL_HOST - The host address of the smtp server to connect to

* MLR_NOTIFICATION_EMAIL_PORT - The port of the smtp server to connect to

## Running the Application

This application can be run locally using the docker container built during the build process or by directly building and running the application JAR. The included `docker-compose` file has 3 profiles to choose from when running the application locally:

1. mlr-notification-service: This is the default profile which runs the application as it would be in our cloud environment. This is not recommended for local development as it makes configuring connections to other services running locally on your machine more difficult.

2. mlr-notification-service-local-dev: This is the profile which runs the application as it would be in the aqcu-local-dev project, and is configured to make it easy to replace the mlr-notification-service instance in the local-dev project with this instance. It is run the same as the `mlr-notification-service` profile, except it uses the docker host network driver.

3. mlr-notification-service-debug: This is the profile which runs the application exactly the same as `mlr-notification-service-local-dev` but also enables remote debugging for the application and opens up port 8000 into the container for that purpose.

### Setting up SSL

This application is configured to run over HTTPS and thus requires SSL certificates to be setup before it can be run via Docker. When running this container alone and not with an MLR Local Dev setup SSL certificates can be configured easily by simply running the included `create_keys.sh` script in the `docker/certificates` directory.

When intending to run this application alongside other MLR service running from the MLR Local Dev project you should use the certificate files generated by the MLR Local Dev project. This is important because in order for the MLR Local Dev services to connect to this service they must trust the certificate it is serving, which is most easily accomplished locally by using the same certificate for SSL among all of the MLR services.

In addition to its own SSL certs, this service must also be able to connect to a running Water Auth server locally, and thus must trust the SSL certificate being served by Water Auth. This can be accomplished by copy-pasting the .crt file that Water Auth is serving into the `docker/certificates/import_certs` folder of this project. Any .crt file put into the `import_certs` directory will be loaded into the certificate store used by Python within the container and trusted by the application.

When using MLR Local Dev this means copying the certificates that MLR Local Dev generates into 2 places in this project:

1. `docker/certificates` to be used as the SSL certs served by this service

2. `docker/certificates/import_certs` to have this service trust other services serving the MLR Local Dev SSL certs

### Building Changes

To build and run the application after completing the above steps you can run: `docker-compose up --build {profile}`, replacing `{profile}` with one of the options listed above.

The swagger documentation can then be accessed at <https://localhost:8443/swagger-ui.html.>
